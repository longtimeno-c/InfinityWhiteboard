<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Whiteboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="toolbar">
        <button id="penTool" class="tool-button active" data-tooltip="Pen (P)" onclick="setTool('pen')">
            <i class="fas fa-pen"></i>
        </button>
        <input type="color" id="colorPicker" value="#000000" onchange="setColor(this.value)">
        <button id="eraserTool" class="tool-button" data-tooltip="Eraser (E)" onclick="setTool('eraser')">
            <i class="fas fa-eraser"></i>
        </button>
        <button id="panTool" class="tool-button" data-tooltip="Pan (Space)" onclick="setTool('pan')">
            <i class="fas fa-hand"></i>
        </button>
        <button class="tool-button" data-tooltip="Clear Board" onclick="clearBoardWithConfirm()">
            <i class="fas fa-trash"></i>
        </button>
        <button class="tool-button" data-tooltip="Undo (Ctrl+Z)" onclick="undo()">
            <i class="fas fa-undo"></i>
        </button>
        <button class="tool-button" data-tooltip="Redo (Ctrl+Y)" onclick="redo()">
            <i class="fas fa-redo"></i>
        </button>
        <input type="range" id="size" min="1" max="20" value="2" onchange="setSize(this.value)">
        <button class="tool-button" data-tooltip="Zoom In" onclick="zoom(1.2)">
            <i class="fas fa-search-plus"></i>
        </button>
        <button class="tool-button" data-tooltip="Zoom Out" onclick="zoom(0.8)">
            <i class="fas fa-search-minus"></i>
        </button>
        
        <!-- Username display in top right -->
        <div id="username-container">
            <span id="username-display"></span>
            <button id="change-username-btn" class="tool-button" data-tooltip="Change Username">
                <i class="fas fa-user-edit"></i>
            </button>
        </div>
    </div>
    
    <!-- Board selector panel -->
    <div id="board-panel">
        <div class="panel-header">
            <h3>Boards</h3>
            <button id="toggle-board-panel" class="tool-button" data-tooltip="Toggle Board Panel">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div id="board-selector">
            <!-- Board options will be added dynamically -->
        </div>
    </div>
    
    <canvas id="whiteboard"></canvas>
    <div id="status" class="disconnected">Disconnected</div>

    <!-- Username Modal -->
    <div id="username-modal" class="modal">
        <div class="modal-content">
            <h2>Welcome to Infinite Whiteboard</h2>
            <p>Please enter a username to continue:</p>
            <input type="text" id="username-input" placeholder="Username">
            <button id="save-username-btn">Save</button>
        </div>
    </div>

    <!-- Clear Options Modal for Shaun -->
    <div id="clear-options-modal" class="modal">
        <div class="modal-content">
            <h2>Clear Options</h2>
            <p>What would you like to clear?</p>
            <div class="modal-buttons">
                <button id="clear-own-btn" class="primary-btn">Clear My Content</button>
                <button id="clear-all-btn" class="danger-btn">Clear All Content</button>
                <button id="cancel-clear-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script src="whiteboard.js"></script>
    <script>
      // Toggle board panel
      document.getElementById('toggle-board-panel').addEventListener('click', function() {
          const boardPanel = document.getElementById('board-panel');
          boardPanel.classList.toggle('collapsed');
          
          // Update the icon
          const icon = this.querySelector('i');
          if (boardPanel.classList.contains('collapsed')) {
              icon.className = 'fas fa-chevron-left';
          } else {
              icon.className = 'fas fa-chevron-right';
          }
      });
      
      // Modify your drawing initialization
      const socket = io();
      let isDrawing = false;
      let currentPath = [];
      let currentTool = 'pen'; // Add tool state (pen or eraser)
      
      // Add this to handle initial canvas state
      socket.on('init-canvas', (drawings) => {
        // Redraw all existing drawings
        drawings.forEach(drawing => {
          if (drawing.type === 'erase') {
            // Handle eraser strokes
            drawEraserPath(drawing.path, drawing.width);
          } else {
            // Handle regular drawing strokes
            drawPath(drawing.path, drawing.color, drawing.width);
          }
        });
      });
      
      // Improve the drawing function
      function drawPath(path, color, width) {
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        if (path.length > 0) {
          ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
              ctx.lineTo(path[i].x, path[i].y);
            }
        }
        ctx.stroke();
      }
      
      // Add a specific eraser function
      function drawEraserPath(path, width) {
        const ctx = canvas.getContext('2d');
        ctx.globalCompositeOperation = 'destination-out'; // This is the key for better erasing
        ctx.lineWidth = width;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        if (path.length > 0) {
          ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
              ctx.lineTo(path[i].x, path[i].y);
            }
        }
        ctx.stroke();
        ctx.globalCompositeOperation = 'source-over'; // Reset to default
      }
      
      // Update your mouse/touch event handlers
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch support
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrawing(e.touches[0]);
      });
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        draw(e.touches[0]);
      });
      canvas.addEventListener('touchend', stopDrawing);
      
      function startDrawing(e) {
        isDrawing = true;
        currentPath = [];
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        currentPath.push({ x, y });
      }
      
      function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        currentPath.push({ x, y });
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear and redraw for smoother experience
        
        // Redraw based on tool
        if (currentTool === 'eraser') {
          drawEraserPath(currentPath, 20); // Wider eraser
        } else {
          drawPath(currentPath, colorPicker.value, 5);
        }
      }
      
      function stopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;
        
        // Send the completed path to the server
        socket.emit('draw', {
          type: currentTool === 'eraser' ? 'erase' : 'draw',
          path: currentPath,
          color: colorPicker.value,
          width: currentTool === 'eraser' ? 20 : 5
        });
      }
      
      // Add tool selection buttons
      const penButton = document.getElementById('penTool');
      const eraserButton = document.getElementById('eraserTool');
      
      penButton.addEventListener('click', () => {
        currentTool = 'pen';
        penButton.classList.add('active');
        eraserButton.classList.remove('active');
      });
      
      eraserButton.addEventListener('click', () => {
        currentTool = 'eraser';
        eraserButton.classList.add('active');
        penButton.classList.remove('active');
      });
      
      // Handle incoming drawing data
      socket.on('draw', (data) => {
        if (data.type === 'erase') {
          drawEraserPath(data.path, data.width);
        } else {
          drawPath(data.path, data.color, data.width);
        }
      });
      
      // Add cursor outline for eraser
      let cursorOutline = document.createElement('div');
      cursorOutline.id = 'cursor-outline';
      cursorOutline.style.position = 'absolute';
      cursorOutline.style.border = '1px solid #000';
      cursorOutline.style.borderRadius = '50%';
      cursorOutline.style.pointerEvents = 'none'; // Make sure it doesn't interfere with mouse events
      cursorOutline.style.display = 'none';
      document.body.appendChild(cursorOutline);

      // Update cursor outline position and visibility
      canvas.addEventListener('mousemove', updateCursorOutline);
      canvas.addEventListener('mouseenter', () => {
        if (currentTool === 'eraser') {
          cursorOutline.style.display = 'block';
        }
      });
      canvas.addEventListener('mouseleave', () => {
        cursorOutline.style.display = 'none';
      });

      function updateCursorOutline(e) {
        if (currentTool === 'eraser') {
          const eraserWidth = 20; // Same as your eraser width
          cursorOutline.style.width = `${eraserWidth}px`;
          cursorOutline.style.height = `${eraserWidth}px`;
          cursorOutline.style.left = `${e.clientX - eraserWidth/2}px`;
          cursorOutline.style.top = `${e.clientY - eraserWidth/2}px`;
          cursorOutline.style.display = 'block';
          
          // Hide the default cursor when using eraser
          canvas.style.cursor = 'none';
        } else {
          cursorOutline.style.display = 'none';
          canvas.style.cursor = 'default';
        }
      }

      // Update tool selection to handle cursor changes
      penButton.addEventListener('click', () => {
        currentTool = 'pen';
        penButton.classList.add('active');
        eraserButton.classList.remove('active');
        canvas.style.cursor = 'default';
        cursorOutline.style.display = 'none';
      });

      eraserButton.addEventListener('click', () => {
        currentTool = 'eraser';
        eraserButton.classList.add('active');
        penButton.classList.remove('active');
        canvas.style.cursor = 'none';
        if (canvas.matches(':hover')) {
          cursorOutline.style.display = 'block';
        }
      });
      
      // ... existing code ...
    </script>
</body>
</html>